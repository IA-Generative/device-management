apiVersion: v1
kind: Namespace
metadata:
  name: bootstrap
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: device-management
  namespace: bootstrap
spec:
  replicas: 1
  selector:
    matchLabels:
      app: device-management
  template:
    metadata:
      labels:
        app: device-management
    spec:
      imagePullSecrets:
        - name: scw-regcred
      containers:
        - name: device-management
          image: rg.fr-par.scw.cloud/funcscwnspricelessmontalcinhiacgnzi/device-management:0.0.1
          imagePullPolicy: Always
          ports:
            - containerPort: 3001
          env:
            - name: DM_APP_ENV
              valueFrom:
                secretKeyRef:
                  name: device-management-secrets
                  key: DM_APP_ENV
            - name: DM_CONFIG_ENABLED
              valueFrom:
                secretKeyRef:
                  name: device-management-secrets
                  key: DM_CONFIG_ENABLED
            - name: DM_CONFIG_PROFILE
              valueFrom:
                secretKeyRef:
                  name: device-management-secrets
                  key: DM_CONFIG_PROFILE
            - name: DM_ENROLL_URL
              valueFrom:
                secretKeyRef:
                  name: device-management-secrets
                  key: DM_ENROLL_URL
            - name: DM_ALLOW_ORIGINS
              valueFrom:
                secretKeyRef:
                  name: device-management-secrets
                  key: DM_ALLOW_ORIGINS
            - name: DM_MAX_BODY_SIZE_MB
              valueFrom:
                secretKeyRef:
                  name: device-management-secrets
                  key: DM_MAX_BODY_SIZE_MB
            - name: DM_PORT
              valueFrom:
                secretKeyRef:
                  name: device-management-secrets
                  key: DM_PORT
            - name: DM_STORE_ENROLL_LOCALLY
              valueFrom:
                secretKeyRef:
                  name: device-management-secrets
                  key: DM_STORE_ENROLL_LOCALLY
            - name: DM_ENROLL_DIR
              valueFrom:
                secretKeyRef:
                  name: device-management-secrets
                  key: DM_ENROLL_DIR
            - name: PUBLIC_BASE_URL
              valueFrom:
                secretKeyRef:
                  name: device-management-secrets
                  key: PUBLIC_BASE_URL
            - name: MODELNAME1
              valueFrom:
                secretKeyRef:
                  name: device-management-secrets
                  key: MODELNAME1
            - name: MODELNAME2
              valueFrom:
                secretKeyRef:
                  name: device-management-secrets
                  key: MODELNAME2
            - name: MODELNAME3
              valueFrom:
                secretKeyRef:
                  name: device-management-secrets
                  key: MODELNAME3
            - name: TOKENMODEL1
              valueFrom:
                secretKeyRef:
                  name: device-management-secrets
                  key: TOKENMODEL1
            - name: TELEMETRY_SALT
              valueFrom:
                secretKeyRef:
                  name: device-management-secrets
                  key: TELEMETRY_SALT
            - name: TELEMETRY_KEY
              valueFrom:
                secretKeyRef:
                  name: device-management-secrets
                  key: TELEMETRY_KEY
            - name: DM_S3_ENDPOINT_URL
              valueFrom:
                secretKeyRef:
                  name: device-management-secrets
                  key: DM_S3_ENDPOINT_URL
            - name: DM_S3_BUCKET
              valueFrom:
                secretKeyRef:
                  name: device-management-secrets
                  key: DM_S3_BUCKET
            - name: DM_S3_PREFIX_ENROLL
              valueFrom:
                secretKeyRef:
                  name: device-management-secrets
                  key: DM_S3_PREFIX_ENROLL
            - name: DM_S3_PREFIX_BINARIES
              valueFrom:
                secretKeyRef:
                  name: device-management-secrets
                  key: DM_S3_PREFIX_BINARIES
            - name: DM_BINARIES_MODE
              valueFrom:
                secretKeyRef:
                  name: device-management-secrets
                  key: DM_BINARIES_MODE
            - name: DM_PRESIGN_TTL_SECONDS
              valueFrom:
                secretKeyRef:
                  name: device-management-secrets
                  key: DM_PRESIGN_TTL_SECONDS
            - name: DM_STORE_ENROLL_S3
              valueFrom:
                secretKeyRef:
                  name: device-management-secrets
                  key: DM_STORE_ENROLL_S3
            - name: AWS_REGION
              valueFrom:
                secretKeyRef:
                  name: device-management-secrets
                  key: AWS_REGION
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: device-management-secrets
                  key: AWS_ACCESS_KEY_ID
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: device-management-secrets
                  key: AWS_SECRET_ACCESS_KEY
            - name: AWS_SESSION_TOKEN
              valueFrom:
                secretKeyRef:
                  name: device-management-secrets
                  key: AWS_SESSION_TOKEN
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: device-management-secrets
                  key: DATABASE_URL
            - name: DATABASE_ADMIN_URL
              valueFrom:
                secretKeyRef:
                  name: device-management-secrets
                  key: DATABASE_ADMIN_URL
          volumeMounts:
            - name: enroll-data
              mountPath: /data/enroll
            - name: config-all
              mountPath: /app/config
          readinessProbe:
            httpGet:
              path: /healthz
              port: 3001
            initialDelaySeconds: 3
            periodSeconds: 5
          livenessProbe:
            httpGet:
              path: /healthz
              port: 3001
            initialDelaySeconds: 10
            periodSeconds: 10
      volumes:
        - name: enroll-data
          emptyDir: {}
        - name: config-all
          projected:
            sources:
              - configMap:
                  name: device-management-config
                  items:
                    - key: config.json
                      path: config.json
                    - key: matisse-config.json
                      path: matisse/config.json
                    - key: libreoffice-config.json
                      path: libreoffice/config.json
                    - key: chrome-config.json
                      path: chrome/config.json
                    - key: edge-config.json
                      path: edge/config.json
                    - key: firefox-config.json
                      path: firefox/config.json
                    - key: misc-config.json
                      path: misc/config.json
              - configMap:
                  name: device-management-config-dev
                  items:
                    - key: config.dev.json
                      path: config.dev.json
                    - key: matisse-config.dev.json
                      path: matisse/config.dev.json
                    - key: libreoffice-config.dev.json
                      path: libreoffice/config.dev.json
                    - key: chrome-config.dev.json
                      path: chrome/config.dev.json
                    - key: edge-config.dev.json
                      path: edge/config.dev.json
                    - key: firefox-config.dev.json
                      path: firefox/config.dev.json
                    - key: misc-config.dev.json
                      path: misc/config.dev.json
              - configMap:
                  name: device-management-config-int
                  items:
                    - key: config.int.json
                      path: config.int.json
                    - key: matisse-config.int.json
                      path: matisse/config.int.json
                    - key: libreoffice-config.int.json
                      path: libreoffice/config.int.json
                    - key: chrome-config.int.json
                      path: chrome/config.int.json
                    - key: edge-config.int.json
                      path: edge/config.int.json
                    - key: firefox-config.int.json
                      path: firefox/config.int.json
                    - key: misc-config.int.json
                      path: misc/config.int.json
                           
---
apiVersion: v1
kind: Service
metadata:
  name: device-management
  namespace: bootstrap
spec:
  selector:
    app: device-management
  ports:
    - name: http
      port: 80
      targetPort: 3001
  type: ClusterIP
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: device-management
  namespace: bootstrap
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - bootstrap.fake-domain.name
      secretName: bootstrap-tls
  rules:
    - host: bootstrap.fake-domain.name
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: device-management
                port:
                  number: 80
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres
  namespace: bootstrap
spec:
  replicas: 1
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
        - name: postgres
          image: postgres:16-alpine
          ports:
            - containerPort: 5432
          env:
            - name: POSTGRES_DB
              valueFrom:
                secretKeyRef:
                  name: device-management-secrets
                  key: POSTGRES_DB
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: device-management-secrets
                  key: POSTGRES_USER
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: device-management-secrets
                  key: POSTGRES_PASSWORD
          volumeMounts:
            - name: postgres-data
              mountPath: /var/lib/postgresql/data
      volumes:
        - name: postgres-data
          emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: postgres
  namespace: bootstrap
spec:
  selector:
    app: postgres
  ports:
    - name: postgres
      port: 5432
      targetPort: 5432
  type: ClusterIP
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: adminer
  namespace: bootstrap
spec:
  replicas: 1
  selector:
    matchLabels:
      app: adminer
  template:
    metadata:
      labels:
        app: adminer
    spec:
      containers:
        - name: adminer
          image: adminer:latest
          ports:
            - containerPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: adminer
  namespace: bootstrap
spec:
  selector:
    app: adminer
  ports:
    - name: http
      port: 8080
      targetPort: 8080
  type: ClusterIP
