worker_processes  1;

events { worker_connections 1024; }

http {
  include       mime.types;
  default_type  application/octet-stream;

  access_log /dev/stdout;
  error_log  /dev/stderr info;

  client_max_body_size 10m;

  server {
    listen 8088;

    location = /config/config.json {
      types { application/json json; }
      alias /srv/config/config.json;
      add_header Cache-Control "no-store";
    }

    location = /enroll {
      limit_except POST PUT OPTIONS { deny all; }

      if ($request_method = OPTIONS) {
        add_header Access-Control-Allow-Origin "*";
        add_header Access-Control-Allow-Methods "POST, PUT, OPTIONS";
        add_header Access-Control-Allow-Headers "Content-Type, Authorization";
        return 204;
      }

      content_by_lua_block {
        ngx.req.read_body()
        local body = ngx.req.get_body_data()

        if not body then
          local body_file = ngx.req.get_body_file()
          if body_file then
            local f = io.open(body_file, "rb")
            if f then
              body = f:read("*a")
              f:close()
            end
          end
        end

        if not body or #body == 0 then
          ngx.status = 400
          ngx.header["Content-Type"] = "application/json"
          ngx.say('{"ok":false,"error":"Empty body"}')
          return
        end

        math.randomseed(ngx.now() * 1000 + ngx.worker.pid())
        local epoch_ms = math.floor(ngx.now() * 1000)
        local fname = string.format("/enroll/%d-%d-%06d.json", epoch_ms, ngx.worker.pid(), math.random(0, 999999))

        local wf, err = io.open(fname, "wb")
        if not wf then
          ngx.status = 500
          ngx.header["Content-Type"] = "application/json"
          ngx.say(string.format('{"ok":false,"error":"Cannot write file","detail":%q}', err or "unknown"))
          return
        end

        wf:write(body)
        wf:close()

        ngx.status = 201
        ngx.header["Content-Type"] = "application/json"
        ngx.header["Access-Control-Allow-Origin"] = "*"
        ngx.say(string.format('{"ok":true,"file":%q}', fname))
      }
    }

    location = /healthz {
      default_type application/json;
      return 200 '{"ok":true}';
    }
  }
}
